<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>MusicBot Control</title>
  <style>
    body {
      margin:0;
      font-family:Roboto, Arial, sans-serif;
      background:#181818;
      color:#eee;
    }
    header {
      background:#202020;
      padding:1em;
      text-align:center;
      font-size:1.8em;
      color:#fff;
    }
    main { padding:1em; max-width:800px; margin:0 auto; }
    button {
      background:#333;
      color:#eee;
      border:none;
      padding:0.5em 1em;
      margin:0.2em;
      border-radius:4px;
      cursor:pointer;
    }
    button:hover { background:#ff0000; }
    input {
      padding:0.5em;
      width:70%;
      margin-right:0.5em;
      border:1px solid #333;
      border-radius:4px;
    }
    #queue { list-style:none; padding:0; }
    #queue li {
      display:flex;
      justify-content:space-between;
      padding:0.5em;
      border-bottom:1px solid #333;
    }
    #queue li button { padding:0.2em 0.5em; }
  </style>
</head>
<body>
  <header>MusicBot Control</header>
  <div id="login" style="position:fixed;top:0;left:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;background:#111;z-index:10;">
    <div style="background:#222;padding:2em;border-radius:8px;text-align:center;">
      <h2>Login</h2>
      <input id="user" placeholder="Username" style="width:100%;margin-bottom:0.5em;"><br>
      <input id="pass" placeholder="Password" type="password" style="width:100%;margin-bottom:0.5em;"><br>
      <button onclick="doLogin()">Login</button>
    </div>
  </div>
  <main>
    <div>
      <button onclick="api('skip')">Skip</button>
      <button onclick="api('pause')">Pause</button>
      <button onclick="api('resume')">Resume</button>
      <button onclick="api('clear')">Clear Queue</button>
      <button onclick="api('loop')">Loop Song</button>
      <button onclick="api('loopqueue')">Loop Queue</button>
    </div>
    <div style="margin-top:1em;">
      <input id="query" placeholder="Song URL or search term">
      <button onclick="addSong()">Add Song</button>
    </div>
    <div style="margin-top:1em;">
      <select id="channels"></select>
      <button onclick="joinChannel()">Join</button>
    </div>
    <div id="status" style="margin-top:1em;"></div>
    <div style="margin-top:0.5em;">
      <input type="range" id="progress" value="0" min="0" max="0" step="1" style="width:80%;">
      <span id="time">0:00 / 0:00</span>
    </div>
    <h3>Queue</h3>
    <ul id="queue"></ul>
  </main>
  <script>
    let auth = localStorage.getItem('auth') || '';
    function showLogin(show=true) {
      document.getElementById('login').style.display = show ? 'flex' : 'none';
    }
    function doLogin() {
      const u = document.getElementById('user').value;
      const p = document.getElementById('pass').value;
      auth = 'Basic ' + btoa(`${u}:${p}`);
      localStorage.setItem('auth', auth);
      showLogin(false);
      loadQueue();
    }
    if (!auth) showLogin(true);
    async function api(cmd, params='') {
      let res = await fetch(`/api/${cmd}${params}`, { headers:{ 'Authorization': auth } });
      if (res.status === 401) { showLogin(true); return; }
      await loadQueue();
    }
    async function addSong() {
      let q = document.getElementById('query').value.trim();
      if (!q) return;
      api('add', '?query=' + encodeURIComponent(q));
      document.getElementById('query').value = '';
    }
    async function removeSong(i) {
      api('remove', '?pos=' + i);
    }
    async function loadQueue() {
      let res = await fetch('/api/queue', { headers:{ 'Authorization': auth } });
      if (res.status === 401) { showLogin(true); return; }
      let data = await res.json();
      let ul = document.getElementById('queue');
      ul.innerHTML = '';
      data.queue.forEach((t, i) => {
        let li = document.createElement('li');
        li.textContent = t;
        let btn = document.createElement('button');
        btn.textContent = 'Remove';
        btn.onclick = () => removeSong(i+1);
        li.appendChild(btn);
        ul.appendChild(li);
      });
      let sel = document.getElementById('channels');
      sel.innerHTML = '';
      Object.entries(data.channels).forEach(([id, name]) => {
        let opt = document.createElement('option');
        opt.value = id;
        opt.textContent = name;
        sel.appendChild(opt);
      });
      if (data.connected) sel.value = Object.keys(data.channels).find(k => data.channels[k] === data.connected) || '';
      let status = document.getElementById('status');
      let dls = Object.entries(data.downloads).map(([q,s]) => `${q} (${s}s)`).join('<br>');
      status.innerHTML = `Playing: ${data.current || 'none'}<br>Voice: ${data.connected || 'none'}<br>Downloading:<br>${dls || 'none'}`;
      let prog = document.getElementById('progress');
      let time = document.getElementById('time');
      prog.max = Math.floor(data.duration || 0);
      prog.value = Math.floor(data.position || 0);
      function fmt(t){let m=Math.floor(t/60);let s=Math.floor(t%60);return `${m}:${s.toString().padStart(2,'0')}`;}
      time.textContent = `${fmt(data.position)} / ${fmt(data.duration)}`;
    }
    async function joinChannel() {
      let id = document.getElementById('channels').value;
      if (id) await api('join', '?channel=' + id);
    }
    document.getElementById('progress').addEventListener('change', e => {
      api('seek', '?pos=' + e.target.value);
    });
    loadQueue();
    setInterval(loadQueue, 1000);
  </script>
</body>
</html>
